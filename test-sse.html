<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Semantic Search Demo</title>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            themeVariables: {
                primaryColor: '#0066cc',
                primaryTextColor: '#fff',
                primaryBorderColor: '#0052a3',
                lineColor: '#333',
                textColor: '#333',
                mainBkg: '#0066cc',
                secondaryColor: '#f8f9fa',
                tertiaryColor: '#e9ecef',
                noteBkgColor: '#fff3cd',
                noteTextColor: '#333',
                noteBorderColor: '#ffc107',
                actorBkg: '#e9ecef',
                actorBorder: '#0066cc',
                actorTextColor: '#333',
                actorLineColor: '#333',
                signalColor: '#333',
                signalTextColor: '#333',
                labelBoxBkgColor: '#0066cc',
                labelBoxBorderColor: '#0052a3',
                labelTextColor: '#fff',
                loopTextColor: '#333',
                activationBkgColor: '#f8f9fa',
                activationBorderColor: '#0066cc',
                sequenceNumberColor: '#fff'
            }
        });
    </script>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-top: 0;
            font-size: clamp(1.5rem, 5vw, 2rem);
        }
        h2 {
            color: #555;
            font-size: clamp(1.2rem, 4vw, 1.5rem);
            margin-top: 20px;
            margin-bottom: 15px;
        }
        .diagram-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow-x: auto;
        }
        .mermaid {
            display: flex;
            justify-content: center;
            background: transparent;
            border: none;
            padding: 0;
            margin: 0;
        }
        pre.mermaid {
            overflow: visible;
        }
        @media (max-width: 767px) {
            .diagram-container {
                padding: 10px;
            }
        }
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
            font-size: 14px;
            margin-bottom: 10px;
            background: white;
            cursor: pointer;
        }

        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
            font-size: 14px;
            margin-bottom: 10px;
            resize: vertical;
        }
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }
        button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            flex: 1 1 auto;
            min-width: 150px;
            white-space: nowrap;
        }
        button:hover { background: #0052a3; }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        #clearBtn {
            background: #6c757d;
        }
        #clearBtn:hover {
            background: #5a6268;
        }

        /* Tablet and larger screens */
        @media (min-width: 768px) {
            body {
                padding: 40px;
            }
            .container {
                padding: 30px;
            }
        }

        /* Mobile adjustments */
        @media (max-width: 767px) {
            button {
                font-size: 14px;
                padding: 10px 16px;
                min-width: unset;
                flex: 1 1 100%;
            }
            h1 {
                font-size: 1.5rem;
            }
        }
        #events {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
            min-height: 200px;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 13px;
        }
        @media (max-width: 767px) {
            #events {
                font-size: 11px;
                padding: 10px;
            }
        }
        .event {
            margin: 8px 0;
            padding: 8px;
            border-left: 3px solid #0066cc;
            background: white;
        }
        .event.scheduled { border-color: #6c757d; }
        .event.started { border-color: #28a745; }
        .event.status { border-color: #ffc107; }
        .event.result { border-color: #17a2b8; }
        .event.done { border-color: #28a745; }
        .event.error { border-color: #dc3545; }
        .event-type {
            font-weight: bold;
            color: #666;
            text-transform: uppercase;
            font-size: 11px;
            margin-bottom: 4px;
        }
        .event-data {
            color: #333;
            white-space: pre-wrap;
        }
        .result-item {
            margin: 4px 0;
            padding: 6px;
            background: #e9ecef;
            border-radius: 3px;
            word-break: break-word;
        }
        .similarity {
            font-weight: bold;
            color: #0066cc;
        }
        @media (max-width: 767px) {
            .event {
                padding: 6px;
                margin: 6px 0;
            }
            .result-item {
                padding: 4px;
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <div class="diagram-container">
        <h2>Architecture Flow</h2>
        <pre class="mermaid">
sequenceDiagram
    participant UI as Browser UI
    box lightblue Proxy Service (python)
        participant Proxy as Python Proxy (8001)
        participant ProxyDapr as Proxy Dapr Sidecar
    end
    box lightsteelblue API Service (dotnet)
        participant APIDapr as API Dapr Sidecar
        participant API as Semantic Search API (5111)
        participant WF as Semantic Search Workflow
    end
    box lightyellow Semantic Search Service (python)
        participant Activity as Python Activity
    end

    UI->>Proxy: POST /semantic-search/stream
    Note over UI,Proxy: SSE Stream Initiated
    Proxy->>ProxyDapr: Dapr Service Invoke
    ProxyDapr->>APIDapr: HTTP Service-to-Service
    APIDapr->>API: Forward Request

    API->>WF: Start Workflow
    Note over API,WF: Event: scheduled
    API-->>UI: SSE: scheduled

    Note over WF,Activity: Event: started
    API-->>UI: SSE: started

    WF->>Activity: Compute Embeddings Activity
    Activity-->>WF: Embeddings Result

    WF->>Activity: Calculate Similarity Activity
    Activity-->>WF: Similarity Results

    WF-->>API: Workflow Complete
    Note over API,UI: Event: result
    API-->>UI: SSE: result with data

    Note over API,UI: Event: done
    API-->>UI: SSE: done
    API-->>Proxy: Stream Complete
        </pre>
    </div>

    <div class="container">
        <h1>üîç Semantic Search</h1>

        <div>
            <label for="model"><strong>Model:</strong></label>
            <select id="model">
                <option value="all-MiniLM-L6-v2" selected>all-MiniLM-L6-v2 (Fast, 384d)</option>
                <option value="all-MiniLM-L12-v2">all-MiniLM-L12-v2 (Balanced, 384d)</option>
                <option value="all-mpnet-base-v2">all-mpnet-base-v2 (Best Quality, 768d)</option>
                <option value="paraphrase-MiniLM-L3-v2">paraphrase-MiniLM-L3-v2 (Fastest, 384d)</option>
                <option value="paraphrase-multilingual-MiniLM-L12-v2">paraphrase-multilingual-MiniLM-L12-v2 (Multilingual, 384d)</option>
            </select>
        </div>

        <div>
            <label for="query"><strong>Query:</strong></label>
            <textarea id="query" rows="2" placeholder="Enter your search query...">How do I reset my password?</textarea>
        </div>

        <div>
            <label for="documents"><strong>Documents (one per line):</strong></label>
            <textarea id="documents" rows="6" placeholder="Enter documents to search...">Steps to update your account password and recover access
Installing the mobile application on your device
Troubleshooting common login and authentication issues
Guide to configuring notification preferences
How to delete your account permanently</textarea>
        </div>

        <div class="button-group">
            <button id="searchBtn" onclick="startSearch()">
                üîç Search Documents
            </button>
            <button id="clearBtn" onclick="clearEvents()">Clear Results</button>
        </div>

        <div id="events"></div>
    </div>

    <script>
        function startSearch() {
            performSearch();
        }

        function performSearch() {
            const query = document.getElementById('query').value.trim();
            const documentsText = document.getElementById('documents').value.trim();
            const documents = documentsText.split('\n').filter(d => d.trim());
            const modelName = document.getElementById('model').value;

            if (!query || documents.length === 0) {
                alert('Please provide a query and at least one document');
                return;
            }

            // Disable button
            const btn = document.getElementById('searchBtn');
            btn.disabled = true;
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ Searching...';

            // Clear previous events
            clearEvents();

            // Use fetch with streaming
            fetch('http://localhost:8001/semantic-search/stream', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'text/event-stream',
                },
                body: JSON.stringify({ query, documents, model_name: modelName })
            })
            .then(response => {
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let currentEvent = null;
                let currentData = null;

                function processText({ done, value }) {
                    if (done) {
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                        return;
                    }

                    buffer += decoder.decode(value, { stream: true });
                    // Split by newline and handle both \n and \r\n line endings
                    const lines = buffer.split(/\r?\n/);
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        const trimmedLine = line.trim();

                        if (trimmedLine.startsWith('event:')) {
                            // If we have a pending event, emit it before starting new one
                            if (currentEvent !== null && currentData !== null) {
                                handleEvent(currentEvent, currentData);
                            }
                            // Start new event
                            currentEvent = trimmedLine.substring(6).trim();
                            currentData = null;  // Use null to distinguish from empty data
                        } else if (trimmedLine.startsWith('data:')) {
                            // Only accumulate data if we have an active event
                            if (currentEvent !== null) {
                                const dataLine = trimmedLine.substring(5).trim();
                                // Concatenate multiple data lines per SSE spec
                                if (currentData !== null) {
                                    currentData += '\n' + dataLine;
                                } else {
                                    currentData = dataLine;
                                }
                            }
                        } else if (trimmedLine === '') {
                            // Empty line signals end of event
                            if (currentEvent !== null && currentData !== null) {
                                handleEvent(currentEvent, currentData);
                                currentEvent = null;
                                currentData = null;
                            }
                        }
                    }

                    return reader.read().then(processText);
                }

                return reader.read().then(processText);
            })
            .catch(error => {
                console.error('Error:', error);
                addEvent('error', { message: error.message });
                btn.disabled = false;
                btn.innerHTML = originalText;
            });
        }

        function handleEvent(eventType, dataStr) {
            console.log(`Received SSE event: ${eventType}, data length: ${dataStr.length}`);
            try {
                const data = JSON.parse(dataStr);
                console.log(`Parsed event data:`, data);
                addEvent(eventType, data);
            } catch (e) {
                console.error('Failed to parse event data:', e);
                console.error('Raw data string:', dataStr);
                // Still try to display something
                addEvent('error', {
                    message: `Failed to parse ${eventType} event: ${e.message}`,
                    rawData: dataStr.substring(0, 200) + (dataStr.length > 200 ? '...' : '')
                });
            }
        }

        function addEvent(type, data) {
            try {
                console.log(`addEvent called: type=${type}`);
                const eventsDiv = document.getElementById('events');
                const eventDiv = document.createElement('div');
                eventDiv.className = `event ${type}`;

                const typeDiv = document.createElement('div');
                typeDiv.className = 'event-type';
                typeDiv.textContent = type;

                const dataDiv = document.createElement('div');
                dataDiv.className = 'event-data';

                // Format data based on event type
                if (type === 'result') {
                    console.log('Formatting result event with data:', data);
                    try {
                        let html = `<strong>Query:</strong> ${data.query}<br><br><strong>Results:</strong><br>`;
                        data.results.forEach((r, i) => {
                            html += `<div class="result-item">
                            ${i + 1}. <span class="similarity">${(r.similarity * 100).toFixed(2)}%</span> - ${r.document}
                            <br><small>(${r.interpretation})</small>
                        </div>`;
                        });
                        html += `<br><strong>Metadata:</strong><br>`;
                        html += `Device: ${data.metadata.device}, Time: ${data.metadata.processingTimeMs.toFixed(2)}ms, Dimension: ${data.metadata.embeddingDimension}`;
                        console.log('Built HTML for result:', html.substring(0, 100) + '...');
                        dataDiv.innerHTML = html;
                        console.log('Set innerHTML on dataDiv');
                    } catch (e) {
                        console.error('Error formatting result event:', e);
                        // Fallback to raw JSON if formatting fails
                        dataDiv.textContent = JSON.stringify(data, null, 2);
                    }
                } else {
                    dataDiv.textContent = JSON.stringify(data, null, 2);
                }

                eventDiv.appendChild(typeDiv);
                eventDiv.appendChild(dataDiv);
                eventsDiv.appendChild(eventDiv);
                console.log(`Appended ${type} event to DOM. Total events now:`, eventsDiv.children.length);
            } catch (e) {
                console.error('Error adding event to display:', e, type, data);
            }
        }

        function clearEvents() {
            document.getElementById('events').innerHTML = '';
        }
    </script>
</body>
</html>
